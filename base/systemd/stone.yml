#
# SPDX-FileCopyrightText: Â© 2020-2022 Serpent OS Developers
#
# SPDX-License-Identifier: Zlib
#
name        : systemd
version     : '251.9'
release     : 3
summary     : A System and Service Manager
license     :
    - GPL-2.0-or-later
    - LGPL-2.1-or-later
    - MIT
homepage    : http://www.freedesktop.org/wiki/Software/systemd
description : |
    A System and Service Manager
upstreams   :
    - https://github.com/systemd/systemd-stable/archive/v251.9.tar.gz: 1a59b8d0382b54be0fc0f8e95d79f5785feef1a2c43f317e31eb8ebf94244dd5
builddeps   :
    - binary(m4)
    - gcc-devel
    - gettext-devel
    - gnu-efi-devel
    - gperf
    - binutils
    - python-jinja
    - pkgconfig(libacl)
    - pkgconfig(blkid)
    - pkgconfig(dbus-1)
    - pkgconfig(fdisk)
    - pkgconfig(libcap)
    - pkgconfig(libcurl)
    - pkgconfig(libffi)
    - pkgconfig(liblz4)
    - pkgconfig(liblzma)
    - pkgconfig(libpcre2-8)
    - pkgconfig(libxcrypt)
    - pkgconfig(libzstd)
    - pkgconfig(mount)
    - pkgconfig(openssl)
    - pkgconfig(pam)
    - pkgconfig(zlib)
setup       : |
    %patch %(pkgdir)/stateless/0001-Remove-default-pam.d-folder.patch

    %meson \
        -Dbpf-framework=false \
        -Defi=true \
        -Dfuzz-tests=false \
        -Dgnu-efi=true \
        -Dinstall-tests=false \
        -Dmode=release \
        -Dpamconfdir="%(vendordir)/pam.d" \
        -Dslow-tests=false \
        -Dsplit-bin=true \
        -Dsplit-usr=false \
        -Dtests=false \
        -Dzstd=true
build       : |
    %meson_build
install     : |
    %meson_install

    # Stateless: Clean up /var directories, they are created via tmpfiles already
    rmdir %(installroot)/var/lib/systemd %(installroot)/var/lib
    rmdir %(installroot)/var/log/journal %(installroot)/var/log %(installroot)/var

    # Stateless: Clean up /etc, contains mostly example configs to learn from that we should put somewhere
    # Actual vendor files can go in /usr/lib/systemd/journald.conf.d for example
    # Test via systemd-analyze cat-config systemd/journald.conf
    rm -rfv %(installroot)/etc
